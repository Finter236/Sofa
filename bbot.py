import logging
import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application, CallbackQueryHandler, CommandHandler,
    ConversationHandler, ContextTypes, MessageHandler, filters
)

# –õ–æ–≥—É–≤–∞–Ω–Ω—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –°—Ç–∞–Ω –±–æ—Ç–∞
MENU, TOPIC, QUIZ = range(3)

# –¢–µ–º–∏
topic_ids = {
    "t1": "–í–∑–∞—î–º–Ω–µ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –ø—Ä—è–º–∏—Ö —É –ø—Ä–æ—Å—Ç–æ—Ä—ñ",
    "t2": "–í–∑–∞—î–º–Ω–µ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –ø—Ä—è–º–æ—ó —ñ –ø–ª–æ—â–∏–Ω–∏",
    "t3": "–§–æ—Ä–º—É–ª–∏ —ñ –≥–µ–æ–º–µ—Ç—Ä–∏—á–Ω—ñ —É–º–æ–≤–∏",
    "t4": "–í–∑–∞—î–º–Ω–µ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –ø–ª–æ—â–∏–Ω —É –ø—Ä–æ—Å—Ç–æ—Ä—ñ",
    "t5": "–ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ—Å—Ç—å –ø—Ä—è–º–∏—Ö –≤ –ø–ª–æ—â–∏–Ω —É –ø—Ä–æ—Å—Ç–æ—Ä—ñ",
    "t6": "–ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ—Å—Ç—å –¥–≤–æ—Ö –ø–ª–æ—â–∏–Ω",
    "t7": "–í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –ø—Ä—è–º–∏—Ö —É –ø—Ä–æ—Å—Ç–æ—Ä—ñ"
}

topics = {
    "t1": """<b>1. –í–∑–∞—î–º–Ω–µ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –ø—Ä—è–º–∏—Ö —É –ø—Ä–æ—Å—Ç–æ—Ä—ñ</b>

<b>–ü–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è</b>
- –ü—Ä—è–º—ñ a —ñ b –º–∞—é—Ç—å –æ–¥–Ω—É —Å–ø—ñ–ª—å–Ω—É —Ç–æ—á–∫—É.
- –Ü—Å–Ω—É—î –ø–ª–æ—â–∏–Ω–∞, –≤ —è–∫—ñ–π –≤–æ–Ω–∏ –æ–±–∏–¥–≤—ñ –ª–µ–∂–∞—Ç—å.
- –ö—É—Ç –º—ñ–∂ –ø—Ä—è–º–∏–º–∏ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ —è–∫ –∫—É—Ç –º—ñ–∂ —ó—Ö–Ω—ñ–º–∏ –Ω–∞–ø—Ä—è–º–Ω–∏–º–∏ –≤–µ–∫—Ç–æ—Ä–∞–º–∏.

<b>–ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ</b>
- –ü—Ä—è–º—ñ a —ñ b –Ω–µ –ø–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è, –∞–ª–µ –ª–µ–∂–∞—Ç—å –≤ –æ–¥–Ω—ñ–π –ø–ª–æ—â–∏–Ω—ñ.
- –á—Ö–Ω—ñ –Ω–∞–ø—Ä—è–º–Ω—ñ –≤–µ–∫—Ç–æ—Ä–∏ –∫–æ–ª—ñ–Ω–µ–∞—Ä–Ω—ñ.
- –í—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –ø—Ä—è–º–∏–º–∏ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Å—Ç–∞–ª–æ—é.

<b>–ó–±—ñ–≥–∞—é—Ç—å—Å—è</b>
- –ü—Ä—è–º—ñ –º–∞—é—Ç—å –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ –±–∞–≥–∞—Ç–æ —Å–ø—ñ–ª—å–Ω–∏—Ö —Ç–æ—á–æ–∫.
- –§–∞–∫—Ç–∏—á–Ω–æ ‚Äî —Ü–µ –æ–¥–Ω–∞ —ñ —Ç–∞ —Å–∞–º–∞ –ø—Ä—è–º–∞.
- –£—Å—ñ –≤–µ–∫—Ç–æ—Ä–∏ –æ–¥–Ω—ñ—î—ó –ø—Ä—è–º–æ—ó –º–æ–∂–Ω–∞ –≤–∏—Ä–∞–∑–∏—Ç–∏ —è–∫ –º–Ω–æ–∂–µ–Ω–Ω—è –≤–µ–∫—Ç–æ—Ä–∞ —ñ–Ω—à–æ—ó –Ω–∞ —Å–∫–∞–ª—è—Ä.

<b>–°–∫—Ä–µ—â—É—é—Ç—å—Å—è (–º–∏–º–æ–±—ñ–∂–Ω—ñ)</b>
- –ü—Ä—è–º—ñ –Ω–µ –º–∞—é—Ç—å –∂–æ–¥–Ω–æ—ó —Å–ø—ñ–ª—å–Ω–æ—ó —Ç–æ—á–∫–∏.
- –ù–µ –ª–µ–∂–∞—Ç—å –≤ –æ–¥–Ω—ñ–π –ø–ª–æ—â–∏–Ω—ñ.
- –ü—Ä–∏–∫–ª–∞–¥ —É —Ä–µ–∞–ª—å–Ω–æ–º—É –∂–∏—Ç—Ç—ñ: —Ä–µ–±—Ä–∞ —Ä—ñ–∑–Ω–∏—Ö –≥—Ä–∞–Ω–µ–π –ø—Ä—è–º–æ–∫—É—Ç–Ω–æ–≥–æ –ø–∞—Ä–∞–ª–µ–ª–µ–ø—ñ–ø–µ–¥–∞.""",

    "t2": """<b>2. –í–∑–∞—î–º–Ω–µ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –ø—Ä—è–º–æ—ó —ñ –ø–ª–æ—â–∏–Ω–∏</b>

<b>–ü—Ä—è–º–∞ –ª–µ–∂–∏—Ç—å —É –ø–ª–æ—â–∏–Ω—ñ</b>
- –í—Å—ñ —Ç–æ—á–∫–∏ –ø—Ä—è–º–æ—ó –Ω–∞–ª–µ–∂–∞—Ç—å –ø–ª–æ—â–∏–Ω—ñ.
- –í–µ–∫—Ç–æ—Ä –ø—Ä—è–º–æ—ó –Ω–∞–ª–µ–∂–∏—Ç—å –ø–ª–æ—â–∏–Ω—ñ, –∞ —Ç–∞–∫–æ–∂ –ø–æ—á–∞—Ç–∫–æ–≤–∞ —Ç–æ—á–∫–∞ –ø—Ä—è–º–æ—ó –ª–µ–∂–∏—Ç—å —É –ø–ª–æ—â–∏–Ω—ñ.

<b>–ü—Ä—è–º–∞ –ø–µ—Ä–µ—Ç–∏–Ω–∞—î –ø–ª–æ—â–∏–Ω—É</b>
- –Ñ–¥–∏–Ω–∞ —Å–ø—ñ–ª—å–Ω–∞ —Ç–æ—á–∫–∞ ‚Äî —Ç–æ—á–∫–∞ –ø–µ—Ä–µ—Ç–∏–Ω—É.
- –ü—Ä—è–º–∞ –Ω–µ –ª–µ–∂–∏—Ç—å —É –ø–ª–æ—â–∏–Ω—ñ.
- –á—ó –Ω–∞–ø—Ä—è–º–Ω–∏–π –≤–µ–∫—Ç–æ—Ä –Ω–µ —î –∫–æ–ª—ñ–Ω–µ–∞—Ä–Ω–∏–º –∂–æ–¥–Ω–æ–º—É –∑ –≤–µ–∫—Ç–æ—Ä—ñ–≤, —è–∫—ñ –ª–µ–∂–∞—Ç—å —É –ø–ª–æ—â–∏–Ω—ñ.

<b>–ü—Ä—è–º–∞ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –ø–ª–æ—â–∏–Ω—ñ</b>
- –ù–µ –º–∞—î –∂–æ–¥–Ω–æ—ó —Å–ø—ñ–ª—å–Ω–æ—ó —Ç–æ—á–∫–∏ –∑ –ø–ª–æ—â–∏–Ω–æ—é.
- –á—ó –Ω–∞–ø—Ä—è–º–Ω–∏–π –≤–µ–∫—Ç–æ—Ä –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏–π –ø–ª–æ—â–∏–Ω—ñ.
- –ü—Ä—è–º–∞ —ñ –ø–ª–æ—â–∏–Ω–∞ –Ω–µ –º–∞—é—Ç—å —Å–ø—ñ–ª—å–Ω–∏—Ö —Ç–æ—á–æ–∫, –∞–ª–µ –Ω–µ –ø–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è.""",

    "t3": """<b>3. –§–æ—Ä–º—É–ª–∏ —ñ –≥–µ–æ–º–µ—Ç—Ä–∏—á–Ω—ñ —É–º–æ–≤–∏</b>

- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∫—Ä–µ—â—É–≤–∞–Ω–Ω—è:
  –Ø–∫—â–æ –ø—Ä—è–º—ñ –Ω–µ –ø–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è —ñ –Ω–µ –ª–µ–∂–∞—Ç—å –≤ –æ–¥–Ω—ñ–π –ø–ª–æ—â–∏–Ω—ñ ‚Äî –≤–æ–Ω–∏ –º–∏–º–æ–±—ñ–∂–Ω—ñ.
  –¶–µ –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–µ—Ä–µ–∑ –≤–µ–∫—Ç–æ—Ä–Ω–µ —Ç–∞ –∑–º—ñ—à–∞–Ω–µ –¥–æ–±—É—Ç–∫–∏.

- –ü–µ—Ä–µ—Ç–∏–Ω –ø—Ä—è–º–æ—ó —ñ –ø–ª–æ—â–∏–Ω–∏:
  –Ø–∫—â–æ —Ç–æ—á–∫–∞ A –ø—Ä—è–º–æ—ó —ñ –Ω–∞–ø—Ä—è–º–Ω–∏–π –≤–µ–∫—Ç–æ—Ä v‚Éó, –∞ –ø–ª–æ—â–∏–Ω–∞ –∑–∞–¥–∞–Ω–∞ —Ç–æ—á–∫–æ—é P —ñ –Ω–æ—Ä–º–∞–ª—å–Ω–∏–º –≤–µ–∫—Ç–æ—Ä–æ–º n‚Éó, —Ç–æ —Ç–æ—á–∫–∞ –ø–µ—Ä–µ—Ç–∏–Ω—É –∑–∞–¥–æ–≤–æ–ª—å–Ω—è—î —Ä—ñ–≤–Ω—è–Ω–Ω—è.""",

    "t4": ("<b>4. –í–∑–∞—î–º–Ω–µ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –ø–ª–æ—â–∏–Ω —É –ø—Ä–æ—Å—Ç–æ—Ä—ñ</b>", "image4.jpg", """<b>–ü–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è</b>: –º–∞—é—Ç—å —Å–ø—ñ–ª—å–Ω—É –ø—Ä—è–º—É.
<b>–ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ</b>: –Ω–µ –º–∞—é—Ç—å —Å–ø—ñ–ª—å–Ω–∏—Ö —Ç–æ—á–æ–∫ –∞–±–æ –∑–±—ñ–≥–∞—é—Ç—å—Å—è.

<b>–í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ:</b>
1. –Ø–∫—â–æ –¥–≤—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –ø–ª–æ—â–∏–Ω–∏ –ø–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è —Ç—Ä–µ—Ç—å–æ—é, —Ç–æ –ø—Ä—è–º—ñ –ø–µ—Ä–µ—Ç–∏–Ω—É –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ.
2. –í—ñ–¥—Ä—ñ–∑–∫–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –ø—Ä—è–º–∏—Ö, —è–∫—ñ –º—ñ—Å—Ç—è—Ç—å—Å—è –º—ñ–∂ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏–º–∏ –ø–ª–æ—â–∏–Ω–∞–º–∏, —Ä—ñ–≤–Ω—ñ."""),

    "t5": ("<b>5. –ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ—Å—Ç—å –ø—Ä—è–º–∏—Ö –≤ –ø–ª–æ—â–∏–Ω—ñ —É –ø—Ä–æ—Å—Ç–æ—Ä—ñ</b>", "image5.jpg", """- –ù–µ –º–∞—é—Ç—å —Å–ø—ñ–ª—å–Ω–∏—Ö —Ç–æ—á–æ–∫ —É –ø–ª–æ—â–∏–Ω—ñ.
- –á—Ö–Ω—ñ –Ω–∞–ø—Ä—è–º–Ω—ñ –≤–µ–∫—Ç–æ—Ä–∏ –∫–æ–ª—ñ–Ω–µ–∞—Ä–Ω—ñ.
- –ü—Ä—è–º—ñ –ª–µ–∂–∞—Ç—å –≤ –æ–¥–Ω—ñ–π –ø–ª–æ—â–∏–Ω—ñ.
- –ü—Ä—è–º—ñ –Ω–µ –ø–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è.
- –í–µ–∫—Ç–æ—Ä –ø—Ä—è–º–æ—ó –Ω–µ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–∏–π –ø–ª–æ—â–∏–Ω—ñ.
- –ú–∞—é—Ç—å –ª–∏—à–µ –æ–¥–Ω—É —Ç–æ—á–∫—É –ø–µ—Ä–µ—Ç–∏–Ω—É (—É –≤–∏–ø–∞–¥–∫—É –ø–µ—Ä–µ—Ç–∏–Ω–∞–Ω–Ω—è)."""),

    "t6": ("<b>6. –ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ—Å—Ç—å –¥–≤–æ—Ö –ø–ª–æ—â–∏–Ω</b>", "image6.jpg", """<b>–û–∑–Ω–∞–∫–∞:</b> 
–Ø–∫—â–æ –¥–≤—ñ –ø—Ä—è–º—ñ, —â–æ –ø–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è —ñ –ª–µ–∂–∞—Ç—å —É –ø–ª–æ—â–∏–Ω—ñ Œ±, –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –¥–≤–æ–º –ø—Ä—è–º–∏–º, —è–∫—ñ –ø–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è —ñ –ª–µ–∂–∞—Ç—å —É –ø–ª–æ—â–∏–Ω—ñ Œ≤, —Ç–æ —Ü—ñ –ø–ª–æ—â–∏–Ω–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ.

<b>–í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ:</b>
1. –Ø–∫—â–æ –¥–≤—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –ø–ª–æ—â–∏–Ω–∏ –ø–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è —Ç—Ä–µ—Ç—å–æ—é, —Ç–æ –ø—Ä—è–º—ñ –ø–µ—Ä–µ—Ç–∏–Ω—É –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ.
2. –í—ñ–¥—Ä—ñ–∑–∫–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –ø—Ä—è–º–∏—Ö, —è–∫—ñ –º—ñ—Å—Ç—è—Ç—å—Å—è –º—ñ–∂ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏–º–∏ –ø–ª–æ—â–∏–Ω–∞–º–∏, —Ä—ñ–≤–Ω—ñ."""),

    "t7": ("<b>7. –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –ø—Ä—è–º–∏—Ö —É –ø—Ä–æ—Å—Ç–æ—Ä—ñ</b>", "image7.jpg", """- –ü—Ä—è–º—ñ, –æ–¥–µ—Ä–∂–∞–Ω—ñ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∏–Ω—ñ –¥–≤–æ—Ö –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –ø–ª–æ—â–∏–Ω —Ç—Ä–µ—Ç—å–æ—é, –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –º—ñ–∂ —Å–æ–±–æ—é.
- –î–≤—ñ –ø—Ä—è–º—ñ, –∫–æ–∂–Ω–∞ –∑ —è–∫–∏—Ö –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∞ —Ç—Ä–µ—Ç—ñ–π, –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –º—ñ–∂ —Å–æ–±–æ—é.""")
}

quiz_questions = {
    "t1": ("–Ø–∫–∞ –æ–∑–Ω–∞–∫–∞ —Ç–æ–≥–æ, —â–æ –ø—Ä—è–º—ñ –ø–µ—Ä–µ—Ç–∏–Ω–∞—é—Ç—å—Å—è?", "–º–∞—é—Ç—å –æ–¥–Ω—É —Å–ø—ñ–ª—å–Ω—É —Ç–æ—á–∫—É"),
    "t2": ("–ö–æ–ª–∏ –ø—Ä—è–º–∞ –ª–µ–∂–∏—Ç—å —É –ø–ª–æ—â–∏–Ω—ñ?", "—É—Å—ñ —Ç–æ—á–∫–∏ –ø—Ä—è–º–æ—ó –Ω–∞–ª–µ–∂–∞—Ç—å –ø–ª–æ—â–∏–Ω—ñ"),
    "t3": ("–Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–∫—Ä–µ—â—É–≤–∞–Ω–Ω—è –ø—Ä—è–º–∏—Ö?", "–≤–µ–∫—Ç–æ—Ä–Ω–µ —Ç–∞ –∑–º—ñ—à–∞–Ω–µ –¥–æ–±—É—Ç–∫–∏"),
    "t4": ("–Ø–∫–∞ —É–º–æ–≤–∞ –ø–µ—Ä–µ—Ç–∏–Ω—É –ø–ª–æ—â–∏–Ω?", "–º–∞—é—Ç—å —Å–ø—ñ–ª—å–Ω—É –ø—Ä—è–º—É"),
    "t5": ("–û–∑–Ω–∞–∫–∞ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ—Å—Ç—ñ –ø—Ä—è–º–∏—Ö?", "–≤–µ–∫—Ç–æ—Ä–∏ –∫–æ–ª—ñ–Ω–µ–∞—Ä–Ω—ñ"),
    "t6": ("–ö–æ–ª–∏ –ø–ª–æ—â–∏–Ω–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ?", "–ø—Ä—è–º—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –≤ –æ–±–æ—Ö –ø–ª–æ—â–∏–Ω–∞—Ö"),
    "t7": ("–ö–æ–ª–∏ –¥–≤—ñ –ø—Ä—è–º—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –º—ñ–∂ —Å–æ–±–æ—é?", "–æ–±–∏–¥–≤—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ —Ç—Ä–µ—Ç—ñ–π –ø—Ä—è–º—ñ–π")
}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [[InlineKeyboardButton("‚ñ∂Ô∏è –ü–æ—á–∞—Ç–∏ –Ω–∞–≤—á–∞–Ω–Ω—è", callback_data="start_learning")]]
    await update.message.reply_text(
        "–ü—Ä–∏–≤—ñ—Ç! –Ø –±–æ—Ç –¥–ª—è –≤–∏–≤—á–µ–Ω–Ω—è –≥–µ–æ–º–µ—Ç—Ä—ñ—ó. –ù–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É ‚¨áÔ∏è",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return MENU

async def menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    keyboard = [[InlineKeyboardButton(topic_ids[tid], callback_data=tid)] for tid in topic_ids]
    keyboard.append([InlineKeyboardButton("‚úÖ –í—Å–µ –≤–∏–≤—á–∏–≤!", callback_data="quiz")])
    await query.edit_message_text("–û–±–µ—Ä—ñ—Ç—å —Ç–µ–º—É –¥–ª—è –≤–∏–≤—á–µ–Ω–Ω—è:", reply_markup=InlineKeyboardMarkup(keyboard))
    return MENU

async def show_topic(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    topic_key = query.data
    topic_data = topics[topic_key]

    # –Ø–∫—â–æ –¥–∞–Ω—ñ ‚Äî —Ü–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç (—Å—Ç–∞—Ä—ñ —Ç–µ–º–∏)
    if isinstance(topic_data, str):
        text = f"<b>{topic_ids[topic_key]}</b>\n\n{topic_data}"
        await query.message.reply_text(text, parse_mode="HTML")
    else:
        # –Ø–∫—â–æ –¥–∞–Ω—ñ ‚Äî –∫–æ—Ä—Ç–µ–∂ (–Ω–æ–≤—ñ —Ç–µ–º–∏ –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º)
        name, img_filename, description = topic_data
        text = f"<b>{name}</b>\n\n{description}"
        with open(f"images/{img_filename}", "rb") as photo:
            await query.message.reply_photo(photo=photo, caption=text, parse_mode="HTML")

    return TOPIC


async def start_quiz(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    context.user_data['quiz'] = iter(quiz_questions.items())
    context.user_data['wrong'] = []
    return await ask_question(update, context)

async def ask_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        tid, (question, answer) = next(context.user_data['quiz'])
        context.user_data['current_q'] = (tid, answer)

        text = f"üß† {question}\n\n(–ù–∞–ø–∏—à—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å —É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ)"
        if update.callback_query:
            await update.callback_query.edit_message_text(text)
        else:
            await update.message.reply_text(text)

        return QUIZ

    except StopIteration:
        wrong = context.user_data.get('wrong', [])
        if wrong:
            wrong_list = "\n".join(f"üîπ {topic_ids[tid]}" for tid in wrong)
            text = f"–ü–µ—Ä–µ–≥–ª—è–Ω—å —Ü—ñ —Ç–µ–º–∏ —â–µ —Ä–∞–∑:\n{wrong_list}"
        else:
            text = "üéâ –í—ñ—Ç–∞—é! –£—Å—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ."

        # –ü—Ä–æ–≤–µ—Ä–∫–∞: –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª –∞–ø–¥–µ–π—Ç ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∫–æ–ª–±—ç–∫
        if update.callback_query:
            await update.callback_query.edit_message_text(text)
        else:
            await update.message.reply_text(text)

        return ConversationHandler.END


async def handle_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_answer = update.message.text.strip().lower()
    tid, correct_answer = context.user_data['current_q']
    if correct_answer.lower() not in user_answer:
        context.user_data['wrong'].append(tid)
    return await ask_question(update, context)

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–ù–∞–≤—á–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –©–∞—Å—Ç–∏!")
    return ConversationHandler.END

if __name__ == '__main__':
    app = Application.builder().token("8125962066:AAHi-aHXVfddpUyfxmsbVpVhjO_XEUH6tCE").build()

    conv_handler = ConversationHandler(
    entry_points=[CommandHandler("start", start)],
    states={
        MENU: [
            CallbackQueryHandler(menu, pattern="^start_learning$"),
            CallbackQueryHandler(show_topic, pattern="^t[1-7]$"),
            CallbackQueryHandler(start_quiz, pattern="^quiz$")
        ],
        TOPIC: [
            CallbackQueryHandler(menu, pattern="^start_learning$"),
            # –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –±—ñ–ª—å—à–µ callback—ñ–≤, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        ],
        QUIZ: [
            CommandHandler("cancel", cancel),
            MessageHandler(filters.TEXT & ~filters.COMMAND, handle_answer)
        ],
    },
    fallbacks=[CommandHandler("cancel", cancel)],
    per_chat=True  # ‚úÖ –≤–∞–∂–ª–∏–≤–∞ –æ–ø—Ü—ñ—è
)


    app.add_handler(conv_handler)
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ")
    app.run_polling()

